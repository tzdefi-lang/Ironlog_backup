# IronLog PWA

IronLog is a mobile-first workout tracker built with React + Vite + Supabase + Privy.
It supports offline-first editing, PWA install, workout templates, analytics, export, and end-to-end CI.

## Requirements

- Node.js 20+
- npm 10+ (`npm ci` is used in CI)

## Quick Start

1. Install dependencies:

```bash
npm ci
```

2. Configure env:

```bash
cp .env.example .env
```

Set values in `.env`:

```bash
VITE_SUPABASE_URL=...
VITE_SUPABASE_ANON_KEY=...
VITE_PRIVY_APP_ID=...
VITE_ADMIN_EMAILS=...
```

3. Run locally:

```bash
npm run dev
```

4. Build and preview:

```bash
npm run build
npm run preview
```

## Scripts

- `npm run typecheck`
- `npm run lint`
- `npm run test`
- `npm run test:e2e`
- `npm run build`

## Supabase Setup

### 1) Apply migrations

This project includes SQL migrations under `/supabase/migrations`.

```bash
supabase db push
```

### 2) Deploy Edge Function (`token-exchange`)

Set required secrets:

```bash
supabase secrets set JWT_SECRET=<your-supabase-jwt-secret>
supabase secrets set PRIVY_APP_ID=<your-privy-app-id>
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=<your-supabase-service-role-key>
supabase secrets set ADMIN_EMAILS=<comma-separated-admin-emails>
```

Deploy function (JWT verification disabled because we validate Privy tokens ourselves):

```bash
supabase functions deploy token-exchange --no-verify-jwt
supabase functions deploy official-content-admin --no-verify-jwt
```

Source file:

- `supabase/functions/token-exchange/index.ts`
- `supabase/functions/official-content-admin/index.ts`

### 3) Data access model

- Client authenticates with Privy.
- Frontend exchanges Privy token for Supabase-compatible JWT via `token-exchange`.
- RLS policies restrict rows by `user_id`.
- Offline mutations are queued and synchronized when network returns.

## PWA

- Service Worker is generated by `vite-plugin-pwa`.
- Existing manifest/icons in `public/` are used.
- Production build outputs `dist/sw.js` and Workbox assets automatically.

## Testing and CI

GitHub Actions workflow:

- installs with `npm ci`
- runs `typecheck`, `lint`, unit tests, Playwright E2E, and build

Workflow file:

- `.github/workflows/ci.yml`

## Notes

- `.env` is ignored by git; keep secrets there.
- `.env.example` contains only variable names.

## iOS Native (SwiftUI)

The iOS native app lives under:

- `ios/IronLog`

### Tooling

- Xcode 16+ (tested locally with Xcode 26.2)
- `xcodegen` (used to generate `IronLog.xcodeproj` from `project.yml`)

### Run iOS app

```bash
cd ios/IronLog
xcodegen generate
xcodebuild -project IronLog.xcodeproj -scheme IronLog -destination 'platform=iOS Simulator,name=iPhone 17' build
```

### iOS Privy native auth

The iOS app now uses `privy-ios` native OAuth (Google / Apple), then exchanges the Privy token through the existing Supabase Edge Function:

- `POST /functions/v1/token-exchange`

Required iOS config values:

- `PRIVY_APP_ID`
- `PRIVY_APP_CLIENT_ID`
- `PRIVY_APP_URL_SCHEME` (default in this repo: `ironlog`)
- `REOWN_PROJECT_ID` (for WalletConnect / wallet login)

Set `REOWN_PROJECT_ID` in:

- `ios/IronLog/IronLog/Info.plist` -> `REOWN_PROJECT_ID`

Privy dashboard requirements:

- iOS app client URL scheme must include `ironlog` (or your custom scheme).
- iOS app identifiers must include your bundle id (default in this repo: `com.syntaxis.ironlog`).

### Run iOS tests

```bash
cd ios/IronLog
xcodebuild -project IronLog.xcodeproj -scheme IronLog -destination 'platform=iOS Simulator,name=iPhone 17' test -only-testing:IronLogTests
xcodebuild -project IronLog.xcodeproj -scheme IronLog -destination 'platform=iOS Simulator,name=iPhone 17' test -only-testing:IronLogUITests
```
