# IronLog PWA

IronLog is a mobile-first workout tracker built with React + Vite + Supabase + Privy.
It supports offline-first editing, PWA install, workout templates, analytics, export, and end-to-end CI.

## Requirements

- Node.js 20+
- npm 10+ (`npm ci` is used in CI)

## Quick Start

1. Install dependencies:

```bash
npm ci
```

2. Configure env:

```bash
cp .env.example .env
```

Set values in `.env`:

```bash
VITE_SUPABASE_URL=...
VITE_SUPABASE_ANON_KEY=...
VITE_PRIVY_APP_ID=...
```

3. Run locally:

```bash
npm run dev
```

4. Build and preview:

```bash
npm run build
npm run preview
```

## Scripts

- `npm run typecheck`
- `npm run lint`
- `npm run test`
- `npm run test:e2e`
- `npm run build`

## Supabase Setup

### 1) Apply migrations

This project includes SQL migrations under `/supabase/migrations`.

```bash
supabase db push
```

### 2) Deploy Edge Function (`token-exchange`)

Set required secrets:

```bash
supabase secrets set JWT_SECRET=<your-supabase-jwt-secret>
supabase secrets set PRIVY_APP_ID=<your-privy-app-id>
supabase secrets set ALLOWED_ORIGINS="https://your-production-domain.com,http://localhost:3000"
```

Deploy function (JWT verification disabled because we validate Privy tokens ourselves):

```bash
supabase functions deploy token-exchange --no-verify-jwt
```

Source file:

- `supabase/functions/token-exchange/index.ts`

### 3) Data access model

- Client authenticates with Privy.
- Frontend exchanges Privy token for Supabase-compatible JWT via `token-exchange`.
- RLS policies restrict rows by `user_id`.
- Offline mutations are queued and synchronized when network returns.

## PWA

- Service Worker is generated by `vite-plugin-pwa`.
- Existing manifest/icons in `public/` are used.
- Production build outputs `dist/sw.js` and Workbox assets automatically.

## Testing and CI

GitHub Actions workflow:

- installs with `npm ci`
- runs `typecheck`, `lint`, unit tests, Playwright E2E, and build

Workflow file:

- `.github/workflows/ci.yml`

## Notes

- `.env` is ignored by git; keep secrets there.
- `.env.example` contains only variable names.
